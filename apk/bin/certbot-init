#!/usr/bin/env sh
#
# NAME
#      certbot-init - create the certificates
#
. /usr/local/AppCentral/cappysan-certbot/.env.install
cd ${APKG_PKG_DIR:-/nonexistent} || exit 1

function logger() {
  echo "${@}" >&2
  syslog --log 0 --level 0 --user SYSTEM --event "${@}"
}
logger "Initializing certbot certificates..."

if test ! -f "${APKG_CFG_DIR}/active"; then
  logger "Certbot certificates are deactivated."
  exit 0
fi

# For every renewal hook that we find, install it before deploy section.
for as_hook in /usr/local/AppCentral/*/renewal-hooks/deploy/*; do
  # Overwrite since it could be more recent,
  # Use rsync to avoid a warning with `cp`
  rsync -a "${as_hook}" /usr/local/AppCentral/cappysan-certbot/renewal-hooks/deploy/
done

if test -d /etc/letsencrypt; then
  rm -fr /etc/letsencrypt
fi
mkdir -p ${APKG_CFG_DIR}/letsencrypt
ln -sf -T ${APKG_CFG_DIR}/letsencrypt /etc/letsencrypt

# Generate a random email
email=$(head -c10 /dev/urandom | md5sum | head -c14)@gmail.com
domains="$(cat ${APKG_CFG_DIR}/domains.conf)"
provider="$(cat ${APKG_CFG_DIR}/provider.conf | xargs)"
commandline="$(cat ${APKG_CFG_DIR}/${provider}.cmdline.conf)"

# Use --manual-auth-hook and --manual-cleanup-hook?
logger "Requesting new certificate..."
echo /usr/local/AppCentral/cappysan-certbot/bin/certbot certonly "${@}" -n -m "${email}" --agree-tos ${commandline} -d "${domains}" >&2
if /usr/local/AppCentral/cappysan-certbot/bin/certbot certonly "${@}" --post-hook "run-parts ./renewal-hooks/deploy/" \
    -n -m "${email}" --agree-tos ${commandline} \
    -d "${domains}" 2>&1 | tee /tmp/certbot.log; then

  if grep -q 'no action taken.' /tmp/certbot.log; then
    logger "Requesting new certificate: Certificate not due for renewal."
  elif grep -q 'unexpected error' /tmp/certbot.log; then
    logger "Requesting new certificate: Certificate generation error."
  else
    logger "Requesting new certificate: Renewal success."
    date > ${APKG_CFG_DIR}/last_run
  fi
else
  echo "${@}" >&2
  syslog --log 0 --level 1 --user SYSTEM --event "Requesting new certificate: Failure"
fi
