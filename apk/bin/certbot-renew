#!/usr/bin/env sh
#
# NAME
#      certbot-renew - renew the certificates
#
# COMMAND LINE
#
#   --force-renewal    Force the renewal of the certificate
#
. /usr/local/AppCentral/cappysan-certbot/.env.install
cd ${APKG_PKG_DIR:-/nonexistent} || exit 1

function logger() {
  echo "${@}" >&2
  syslog --log 0 --level 0 --user SYSTEM --event "${@}"
}

if test ! -f "${APKG_CFG_DIR}/active"; then
  logger "Certbot certificates are deactivated."
  exit 0
fi

# Always reset the permissions
chown admin:root ${APKG_CFG_DIR}
chmod 750 ${APKG_CFG_DIR}
chown admin:root ${APKG_CFG_DIR}/*.conf
chmod 600 ${APKG_CFG_DIR}/*.conf

# last_run records last success
if test ! -f ${APKG_CFG_DIR}/last_run; then
  exec /usr/local/AppCentral/cappysan-certbot/bin/certbot-init "${@}"
fi

# For every renewal hook that we find, install it before deploy section.
for as_hook in /usr/local/AppCentral/*/renewal-hooks/deploy/*; do
  # Overwrite since it could be more recent,
  # Use rsync to avoid a warning with `cp`
  rsync -a "${as_hook}" /usr/local/AppCentral/cappysan-certbot/renewal-hooks/deploy/
done

logger "Requesting certificate renewal..."
echo /usr/local/AppCentral/cappysan-certbot/bin/certbot renew --no-random-sleep-on-renew "${@}" >&2
if /usr/local/AppCentral/cappysan-certbot/bin/certbot renew --no-random-sleep-on-renew "${@}" 2>&1 | tee /tmp/certbot.log ; then
  if grep -q 'Certificate not yet due for renewal' /tmp/certbot.log; then
    logger "Rewewing certificate: Pass. Certificate not due for renewal."
  else
    logger "Renewing certificate: Success."
    date > ${APKG_CFG_DIR}/last_run
  fi
else
  echo "${@}" >&2
  syslog --log 0 --level 1 --user SYSTEM --event "Renewing certificate: Failure"
fi
