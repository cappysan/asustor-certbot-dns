#!/usr/bin/env sh
#
# NAME
#      certbot-renew - renew the certificates
#
# COMMAND LINE
#
#   --force-renewal    Force the renewal of the certificate
#
as_cfg=/share/Configuration/certbot-dns
if ! test -f "${as_cfg}/active"; then
  exit 0
fi

# For every renewal hook that we find, install it before deploy section.
for as_hook in /usr/local/AppCentral/*/renewal-hooks/deploy/*; do
  cp -f "${as_hook}" /usr/local/AppCentral/cappysan-certbot-dns/renewal-hooks/deploy/
done

# Always reset the permissions
chown root:root ${as_cfg}/
chmod 700 ${as_cfg}/
chown root:root ${as_cfg}/*.conf
chmod 600 ${as_cfg}/*.conf

if ! test -f ${as_cfg}/last_run; then
  exec /usr/local/AppCentral/cappysan-certbot-dns/bin/certbot-init "${@}"
fi

syslog --log 0 --level 0 --user SYSTEM --quiet --event "Requesting certificate renewal..."
echo /usr/local/AppCentral/cappysan-certbot-dns/bin/certbot -q renew --no-random-sleep-on-renew "${@}" >&2
if /usr/local/AppCentral/cappysan-certbot-dns/bin/certbot -q renew --no-random-sleep-on-renew "${@}"; then
  date > ${as_cfg}/last_run
fi
